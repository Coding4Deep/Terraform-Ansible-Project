- name: clone git repository
  git:
    repo: 'https://github.com/Coding4Deep/Terraform-Ansible-Project.git'
    dest: /opt/Terraform-Ansible-Project
    version: springboot
    force: yes
  register: git_clone

- name: build the springboot application
  shell: mvn clean package -DskipTests
  args:
    chdir: /opt/Terraform-Ansible-Project/
  when: git_clone.changed

- name: Remove everything from Tomcat webapps directory
  file:
    path: "{{ tomcat_install_dir }}/webapps"
    state: absent

- name: Recreate empty Tomcat webapps directory
  file:
    path: "{{ tomcat_install_dir }}/webapps"
    state: directory
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_user }}"
    mode: '0755'

- name: Find the WAR file generated by Maven
  shell: ls /opt/Terraform-Ansible-Project/target/*.war
  register: war_file

- name: Deploy application WAR as ROOT.war
  copy:
    src: "{{ war_file.stdout }}"
    dest: "{{ tomcat_install_dir }}/webapps/ROOT.war"
    remote_src: true
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_user }}"
    mode: '0644'
  notify: Restart Tomcat